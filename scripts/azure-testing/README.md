# Azure Testing Scripts

This directory contains scripts for setting up and managing Azure test infrastructure for TopDeck.

## Quick Start

```bash
# 1. Set up Azure trial subscription
./setup-azure-trial.sh

# 2. Load configuration
source azure-setup.env

# 3. Deploy test infrastructure
./deploy-test-infrastructure.sh

# 4. Validate deployment
./validate-deployment.sh

# 5. When done testing, clean up
./teardown-test-infrastructure.sh
```

## Scripts

### setup-azure-trial.sh

Sets up an Azure 30-day trial subscription for testing.

**What it does:**
- Verifies Azure CLI installation and login
- Checks subscription type (trial/free)
- Creates shared resource group
- Sets up storage account for Terraform state
- Configures cost budget settings
- Saves configuration to `azure-setup.env`

**Usage:**
```bash
./setup-azure-trial.sh
```

**Requirements:**
- Azure CLI installed
- Active Azure subscription
- Email address for alerts

### deploy-test-infrastructure.sh

Deploys test infrastructure using Terraform.

**What it does:**
- Initializes Terraform
- Validates configuration
- Plans deployment
- Deploys resources with confirmation

**Resources created:**
- Resource group
- Cost budget with alerts
- Storage account (optional)
- Virtual network (optional)
- Network security group (optional)

**Usage:**
```bash
./deploy-test-infrastructure.sh
```

**Requirements:**
- Terraform installed
- `test.tfvars` configured
- Azure credentials set

### validate-deployment.sh

Validates that infrastructure was deployed correctly.

**What it does:**
- Checks Terraform state
- Verifies resource group exists
- Lists all created resources
- Validates budget configuration
- Shows estimated costs

**Usage:**
```bash
./validate-deployment.sh
```

### teardown-test-infrastructure.sh

Destroys all test infrastructure.

**What it does:**
- Plans destruction
- Confirms with user
- Destroys all resources
- Cleans up Terraform state

**Usage:**
```bash
./teardown-test-infrastructure.sh
```

**⚠️ WARNING:** This permanently deletes all test resources!

## Configuration Files

### azure-setup.env

Generated by `setup-azure-trial.sh`. Contains:
- `ARM_SUBSCRIPTION_ID` - Azure subscription ID
- `AZURE_STORAGE_ACCOUNT` - Terraform state storage
- `AZURE_RESOURCE_GROUP` - Shared resource group
- `AZURE_LOCATION` - Azure region
- `BUDGET_EMAIL` - Email for alerts
- `MONTHLY_BUDGET` - Budget limit

**Usage:**
```bash
source azure-setup.env
```

### test.tfvars

Terraform variables for test deployment. Create from example:
```bash
cd ../../src/topdeck/deployment/terraform/templates/azure
cp test.tfvars.example test.tfvars
```

## Cost Management

The scripts create cost controls to prevent overspending:

### Budget Configuration

- **Default limit:** $50/month
- **Alert at 80%:** Warning email
- **Alert at 100%:** Critical email

### Estimated Costs

With minimal test resources:
- Storage account: ~$0.15/month
- Virtual network: Free
- Network security group: Free
- **Total: < $5/month**

### Monitoring

```bash
# Check current costs
az consumption usage list --start-date 2025-10-01

# View budget status  
az consumption budget list
```

## Workflow

### Initial Setup (Once)

1. Run `setup-azure-trial.sh`
2. Configure `test.tfvars`
3. Source `azure-setup.env`

### Daily Testing Cycle

```bash
# Morning - Deploy resources
./deploy-test-infrastructure.sh

# Test TopDeck discovery
# ... your testing ...

# Evening - Clean up
./teardown-test-infrastructure.sh
```

### Complete Cleanup

```bash
# Remove test resources
./teardown-test-infrastructure.sh

# Remove shared resources (optional)
az group delete --name topdeck-shared --yes
```

## Troubleshooting

### Script fails with "command not found"

**Problem:** Azure CLI or Terraform not installed

**Solution:**
- Install Azure CLI: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli
- Install Terraform: https://www.terraform.io/downloads

### "Not logged in to Azure"

**Problem:** No active Azure login

**Solution:**
```bash
az login
az account show
```

### "terraform.tfstate not found"

**Problem:** Terraform not initialized or state missing

**Solution:**
```bash
cd ../../src/topdeck/deployment/terraform/templates/azure
terraform init
```

### "Storage account name not available"

**Problem:** Storage account name must be globally unique

**Solution:** Edit `test.tfvars` and change storage account name prefix

### Budget alerts not received

**Problem:** Email not configured or in spam

**Solution:**
1. Check spam folder
2. Verify email in `test.tfvars`
3. Allow up to 24 hours for activation

## Best Practices

### Cost Control

1. **Destroy when not testing** - Run teardown daily
2. **Set conservative budgets** - Start with $20-30
3. **Monitor daily** - Check costs in first week
4. **Use free tier** - VNets and NSGs are free

### Security

1. **Never commit credentials** - Keep `.env` files local
2. **Use service principals** - Not user credentials
3. **Rotate secrets** - Change every 90 days
4. **Limit permissions** - Use Reader role for discovery

### Testing

1. **Start minimal** - Use basic resources first
2. **Test incrementally** - Add resources gradually
3. **Validate each change** - Run validate script after changes
4. **Document issues** - Keep notes for troubleshooting

## Advanced Usage

### Custom Resources

To add custom test resources, edit:
```
../../src/topdeck/deployment/terraform/templates/azure/modules/test_resources/main.tf
```

### Multiple Environments

Deploy multiple test environments:
```bash
# Dev environment
terraform workspace new dev
terraform apply -var-file="test-dev.tfvars"

# Test environment
terraform workspace new test
terraform apply -var-file="test-test.tfvars"
```

### CI/CD Integration

Run in automated pipelines:
```bash
# Non-interactive deployment
./deploy-test-infrastructure.sh <<< "y"

# Run tests
pytest tests/integration/azure/

# Cleanup
./teardown-test-infrastructure.sh <<< "y"
```

## Support

For issues or questions:

1. Check the main documentation: `../../docs/AZURE_TESTING_GUIDE.md`
2. Review Terraform errors: `terraform show`
3. Check Azure Portal for detailed information
4. Open a GitHub issue with logs and details

## Related Documentation

- [Azure Testing Guide](../../docs/AZURE_TESTING_GUIDE.md) - Complete setup guide
- [Terraform Templates](../../src/topdeck/deployment/terraform/templates/README.md) - Template documentation
- [Azure Discovery](../../src/topdeck/discovery/azure/README.md) - Discovery implementation

---

**Remember:** Always clean up resources to avoid unnecessary costs!
